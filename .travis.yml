sudo: required

language: python

python:
  - '3.6'

services:
  - docker

env:
  global:
    - secure: "BckFz24SLylKj7tG6zKVxRvLBlg5JHguKWQza6ahBv8fkqes0S21zQ2gH4uhIbNYUqsJXJy21gjBz1PGhW/9ho+FyumZ0grCP18fEHBj2ynVNMIndRO+hVgLEOzcL9OjzhnboUcd6viuidrQYoPmblsrWaR6BryR9uGhgoyQ+hDRaaWuQ6LomCM3UavH0F+7hkJFbLWee538aPRx2nZR9LZIPQ2Uva9so0IZnydYer6G1Y32b0S8YTjN5Z56q+DwTwUS6mjAqu9ScZceOHC8IM/KhsuUc8sBiC+ONA/Z9/YNMOcPVYONTQhFKVbAqCf7rlkVyXD5MlEF06tr+G2a1Q3JQz/h5sefQcSPPl00u5tCztRhao/xVF+u/JiDGCN/+1/KvBo/XJu8OIEOucc5jkuAFyqmtUaFIRVjV0PTqlV6hTnzkQ/YWqMh5aUm040SHS5n+cjIEELbC7u/hFYT7wYtox4NVcGmF6a4IS0OTyk2kaP17XwVz0PEhhzalY8AitlPH2+RqL/abGVdRUQ8vFGPNSh2mmYQL2SqBdUk3lza72s2cD077CzDgObO6HFbHtjfCDb7cUBAvgdgCWROauTDQvspsq1edhkdK3IfDsmLNzKe83jWxM80ZCLUrbCOcZVBDzNhecL7FOFDKfeXrjeW0zJpUDS0XmhAsEmOvWU="
    - secure: "ZVPhBfgxXl29z+0QgimcKFT7fKySY1grHc1wgCbeABeySzlf+SRTHKR9M1QGDEejO7tWkzY0MMXDqKSCSIsN2ExLoAjKshlFzJ4Szo7akQS2814+Ulm9XZZKEC9dGf1GAp4LtztfqpCdOE7WBLMEhKyMsujRTZetdieCeqQaignTN32yWNNRqE7reZ52TG6xfevcgAgLPUQfebbCPVDLCwQ/FSpuNyhY9kmE+4BgVSRbSDgfNLVvx7vHR3rdhhogGE46SvH2TA8RMjqcF39dvGwKymMZN0DlWBoNCFaU85d5wUV7uJyNAlgS1W8kRnQUK8TfBjJimWTNswkJmN4WXVVywOQfyYnuGx7c2NtTLmzIzlo/wTZ9InPD3hN8W3DPyj57Z6D6mwFn7BAiQgIni4Hl8PPdvCmECjQOftvm7Xsq8KEheRk+/w39+Ns5DlWV4D/4IQVCOGDEvmJ3jrV6ysC8nszlKuWiNX4XIrnnmtgURzMEPKhRXgtdPMvQqOL/W4wQ0kCe1I2/rayPiBTSoA9rMQIz4X6H9CQAjUSPbbbkpQZkEeHn3bo9th2Cdgm1IPD3Vdy8KhcOsbfdZZ78fyrbCOsFl/YuCn0nu/U7jq77lRT8B9rZFt77MG+1OjtNvO4bSRbINXkNHMOVMAH3Mt8KSlCUntIrT46kxAszt1A="
    - secure: "QOuAqZ1GYkkHv/OyEFUCjA4MzDZwpCyoGcV8vG51itHKLCHFVzJQ9UPVVnD8rFu/vVegaB9DlwcEQY8U8nXuyxx45nzXqFA97nDvwhR9z5/6zO1OFsfi4eUbypTPf/phCZ6ay3KERXdiqy4lQ6KdRt9Ids6BjoMujzCC8LVK9V57O7coCG8YocojBtf/tDN5yUAIbJlUzsSarGbgF62RboA7/4qt+hDEVTGfRX5sfXLcpTzfjb9vSZserUn1rY0ZztzaTqgeRn0nTHmo6rn2YNVrqWw7TW/IOBmaz6rn0HiYwTqFZE4UFmbWpHatPH5lbeCC/oiRH/govcZj4ByUaa0TlOkWvV1g+BhRjz2Un63O6jcNY999sCjqiRwTpuCAHxS88H2NVNzUJPLFEgNSml+leTF+r8FadmMbjQzX56vaiWuQOMiFg74BdJ70HoIitS1A6xxsZNN8F1ctg+OSD7c7fg+0SgMPrTRySSjHI7L6XuS5vWBbIf9BvuOcTtjXlnxKoAdtDrkE52sLgzgRNakoVdmO2iKPuhKn5WVq3AGWXZ7W+MJRFUG3weFRNbWEqXje53/twt6L/Bg9VBMWa+ruIGdnUPGmhiioe+hg3MgoS8qQpjOG05c1Jg3GB9bsWai99RdBDf+zeenh7o7z/xld2YtVOyV6Rfcghm8di70="
    - secure: "bmWU7YTZDLOfnW1rz6A/lqdJNpr45udQtcgA/fD1e6ClD8IqffEqP0J07jeuP3+RrhYFz7/TPV36+h/O78BP4pPl06TmkG5EpYMsivweBI4KMed56++gqQXVC8NX95vMuVpErlMhjC7gNG6XVN2Oi0k4DnDHjuWTWNLeb9JTDJVvgEOWe0Oc38xriQZYP0O/MGD2VBehiI0T8Q/wPqMMwov9j05TutbFJkmfB1rQd1R2GngIrOX5QXdvmNyBEtKbhbytmTsbLNgRUI1a6u7ozyl+ZlZHvlvbdy9IjkKSvFV4mRzx6091y2t0StZb3nDhEJuquCORR4X4ev/YSQwssm7Y201vlHbR4hRf+Wru2yB3B+8IyGCGeBTIMhyxE4zNDNJgSdY5gmUMUTLMQHd41ULdGIKuFjXFrXN2SgX6xf6U5cur/02lZwGEZYBwfjsf8fIv0CgJ0DQrchJzVNoq0UT9zflO67LQAYsmwyO01vVIsc7AJuzYFpFfikjYW+2TCykjWunianVce7zIhuftZzEFWF//d+JDvD1v9qIEfznRVR1DnnLZr9GImS0lPndVDz3il36mv3yObmRgCJ2YCtlQRIyMZ3sgWiejQLscb/8oywQux0aG7Z6A0dSL0ZE4JgJZhXZdlnL6ctcZVBl8FHu0GD1izHbdZwlwE0p/8WQ="
    - secure: "MyZq1SYe7RLSWZWfjWkgYOUhAIu59VedDQOdQY7ckpPvpUzppnMo9AlyZd64z9gPfV/LBOFFT9J2oradW373uArlc3xNeMx1Nn4SFYJY/cg2mcN/gZ5HdkWysSPtRtckZIi1cXHyjYmmdVZWGCaWXusfESk4sQKLm8ts4/9Av8SB3TvosNZK+P24Q+b59MXw/zSSpjjCSMDEVu1tOrBcEBgnrXXlmSC41we5RNfX5FPC0BeqdppLFFmDdneZ4hNR2PKCYAms1zweQEwdFlIXQRltcYywTse5Eq3jgzHXsWsEFpo0akMKT5PHT8gGi/7hge43NpU09SAw/4+t5SQEbuO8t9UkoS/CI2QVfjlMRUytaL/Xa4B98idjmjkyQu1GlqoMG8SKir1HWVvpJxw9B4FbOcl7COMZDAD6ieGKg2/zfCo0RGdW3Rkhs5URGK5tfIXh+YJcNgxuUv6DEMO6pitEWZWMnd6ttpic0gpasrv5po8dgR5HG4ThBncYva/A8hjF/uhdpFp7hQqbIepk5dw2mCywc3+fX2CdKKxFZ5H5cqAW8MF1hlL03mYwDBbqPULMmYL/Vxf+vGM+0lsjkcCxFlhz8oXMfdKiSomCu02kyfExdzFeKDCOkJZoWANpt6Ii/tIa7JwlUq+bwX1Kb05zWt498/O6hgmtLHFEs3g="
    - secure: "ZKmWMDhDIDpCd5AA9q30LY8lrBuL3nE/bJFMb0oAGhDIZvk66thiI45IpGtgvjtrjLve6GGXFo70cGtl/nwWArgbcJmGJtLFQwQfXrYd4nzAc+K4dmSnOeVwER461/YGdFpL1m3UdAvG5+dI2iILs5CdBqCaN926z8So9FhogZ69Fba4r40BkUpqYOZrkhe2mCY8S8fjcbIGNnLuU2XA0TwtDVUnftZXVDFhdfGtV1JBUmmSbe48oiYoba2E8mVx5I8hk6EaRFWhCPmJaOhiWag7Wogtnjhyryzp/K/JTsnLCgroTCKKE+Tp7XD6bFP+ZA2FZNwp9m7Nu6qJXfr3B5gYhv5c+zn7RSgw2yqXrY6CRIK5OWFuq/qKh960SvQqGGtDoQxrzcUH96/jtTB0jjr4IIOa/HDt8mmmjnyHjvtgzfSIN/ADbX2Dwkz2ge+sXDmcf7U+srmnViRQBVhYJ8FZOgP/Aq1GpJpmOKLlnrHUmyywD9qul78HtTHQV5cxSNChxwKeyjhUikTa5fqtK4ZbrNkSJoht8zqju/fDblhnmVOGjnuqlcPseab4l0RMR6L312/wStmqgbu8m9jpKzlKbMw68lAjZZHgdFlqEE0MMbeOPNMREuKM+yMZL1ETN76mpaHjkYkJw1B6lix9jG34r1WnlAnNr/cCq5MwiM8="
    - secure: "c+6byifOvDAGR3SHB1a4Iivjzo1xQGa/U0/w4ex/iwFKGCO2wPkXn/HDS5ONVwHFgZHdy55RxNBBfXOtVycoph80A/6wQvfjdi13nx5Yf70CTHI/r3PuRYS11sV1avat5PTfcc2vnRB0xHDps12ekz5Q0sShamtVVmCmFopwdkS6jM3YyaKpPjm3C4zc7dufbcwFjflyuvpTrWnsoU0Oz+pqwR5XNaRTDfsZwdTFASH6HlpfkBiantT2B2EEyLdwIC3iRYP/2pYG4teiU3+znEkQjxl9+ZvPS0JE5tb0InX8XhSgTV4z9TYJ4/3lwJzQk/ifoofVSxL4WB4x6VHbL/7IAhiGSmmJTUQeSGSdsglPH3VV4QSsZfMicjpu4GYeckhvDGk2w+puRhLBiGxDUBW2qTKaHFSeW+8PXem63T0yf4hWEHYqAkSJ8NoxLfjIkig9CerPXjDVcJPAINeyVebUp4RldF8BA8wA2OoyPZEZAaVAhul3BUChFePzb8k7wmafSb6ry7Edgw4IEpgU1xywO7xTF4yxtSCk6tR5HmH4xPKsMsMTvWGf2omMH1SqhKUU4yCs3o/L/lQRILcHOh2RlA+i17lKRQTGI38yUZ5zTz086y6v2m/k7M4kMnf55ogUHAdsV9AGrotzfuwApMTP7Dp3b2TGqcaCefKC+FQ="
    - secure: "mIJ4FVfKkI3cSgdRM+QK/yRMVljM3kTTjWm9NjtmNdBOEKb+1VN/9vkBOuiw1mA/nNJFUhBz/KoL0W3nZjpsWDCV+FtOdiYGaOWct/Qx0052TRbPbZ3m/n2OUqNL+YutJJY7Iad/9FE3P4tpT8bn2RaJc4lantSQMQvZQclM5r4cVRZvPrDCti82Mw0gYI1uRde5FXWlvJM9OY7XStbQ56w9XaSMkMYQKm2B/rsxpxVCnj8vsk6E2OhDgdhfsuVV8wT3ob+62a4yFjqvwD2jOFL5cmen/YesEny496zZwdAFIwyKmvwWGfmVv69cDwDo73LCSLeIcezZsWgls+NrtRtyk4YJVKaQYgN+iEeM04WM/pwWS0jREj2XCVMlNzcycXCK96qtefBBHWUB1XVR5Y04aVKCvo4STkpRvxsmJLMok8KQPx8F4h/kXIk3luqn++92MyTtuIGWhCeTtx6m7+iWN4NvL7OZOknoxdKsHxhDgF7uKbdgwaaO2ryg49Rh1n7lcBF9f3qLXm3G/4o9SqFALGD2OpyKSQ+K8nA5T79jKXG3p0VP/xtHzjR4E9K79kQ8vZbv0/e8AhxxylQMg38VSnY6S33ThwxMnMvCzsU9sRAsEtMs+2XkQ/e7ukddyesCU0lzhqYCXCWGu9dertG2bJA0+kw5Mr7oE+VE94E="
    - secure: "YwNxY7ilboJiBIko6F2CmlIS36eU/EjN94g4M63x5qq7Blf+BZ6TwoHUz+I4DyeQdCg1KfT/iK0rlfoWlLNS4OSh3kSuxkjeWzCLLUlvZ96fX6z5g3fRTvjm+I6KoK+xXP7bXTSR1rZqQURqEPcSAtC+y/BB39tN4Fl82x3pMG8PJnS0f4mgDWShBT4k4SnKYiN12etTc1Gdez6UG5JzZY9TzPIgcg4gCoSRh2jG9jLKSB5JC/yjTi9oDtRx3A0TSGlLV3NzUpKHZTdockNJ9jmUIjDSUlZzkvmrdEHqWPcuvZ2CjS4tPn/avBGfjAwhK0URakuwOw6CUvge7yYGW7JiWt5RA4PDYYrf4jnZzkZlnCiXLPKIzxxlZuA40D7Zq3wSsq0NYg3feHRD0oWVMPvSN8KZ1hsz2fUSVJe6bBTfF3RQ1WMm2zbiOAGyft5KW/LANgVEK8V/Pku1oXjZAaGI7Y9UEH0In3eeGEa3QF1lJ7wbhFJ6EFnkMXIkZz8kfjvLGpsjI/z33V5UynIZVF2/Vkj8GtGqKihS20cu2iwrGcJxm5YP2fU/p5qUdLmi1J0vDsHF9ZiNECKYW1qIJ4TA7dRccXSgIpIiTQl4G90IDXWwS2JqDiIKR9z1y2rZj/R2bqGMoJvzzhSijWzvbIAN+cgtVeMbh5cdVF1502k="
    - STAGING_RESULT: false
    - DEPLOY_PRODUCTION: false
    - DEPLOY_IDENTIDOCK_IMAGE_TAG: "master"

  DOCKER_COMPOSE_VERSION: 1.11.2
  DOCKER_VERSION: 17.03.0-ce

before_install:
  - sudo apt-get -qq update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-engine
  - sudo docker --version
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - which docker-compose
  - docker-compose --version

install:
  - pip install coveralls

script:
  - make test-unit
  - make test-component

after_success:
  - coverage combine --append && coveralls
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then
        make build-tag-push;
    fi

before_deploy:
  - openssl aes-256-cbc -K $encrypted_18064ed45155_key -iv $encrypted_18064ed45155_iv -in travis_deploy_rsa.enc -out /tmp/travis_deploy_rsa -d
  - eval "$(ssh-agent -s)"
  - chmod 600 /tmp/deploy_rsa
  - ssh-add /tmp/deploy_rsa
  # - if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then
  # make deploy DEPLOY_ENVIRONMENT=staging && make test-e2e;
  # fi

deploy:
  provider: script
  skip_cleanup: true
  script: make deploy
  on:
    branch: master
    condition: "$DEPLOY_PRODUCTION = true"
    # tags: true

notifications:
  email:
    recipients:
      - anirban.nick@gmail.com
    on_success: never
    on_failure: always
  
  slack:    
    rooms:
      - secure: ElBCmf555oP8e9pghlxWGkC8qIWr7ieYv7K8vnLlAbQ1PLKqISM8ENmgMYG/qr0pxCS7m/GWzKsWk72swOtYjFY0ddrZJS905FjrmFKllonnDP2Rh7f+SoRathta6pHEILE7bMMNJ8lyr48Ww2JohyZ+S8qm5bzMWxxdCIeP76anrMDWiQFa++a06I456lZhNSS/DMUJEf/18WyPL+wuPhamgbLdrlrY961IgotPI7e+3nvj8IXEyHy/MJME2E7F7vnOW+lpsgs0sDqSzWnHD+cyOD/Wng+Zpwpu80SIHE4rC0rq+5jtt+lgfmiyRGtUrHuqErcqyjNjed73QMftdq/46qaHKwoWUrmX0s2aSF/9bfACZyEeZsFgBzJ8r6/GRJqMLI/1UI2mhUXYkkTyq9fDEZMOHlAc9ZlDCxZxchpc5rHlg7yKRzGS3XIYkpjVw0XRui3axCHt1Q5mYQaK417OYW4U6Sy8iKe5R6ao3YNuwMl24A7mkr8rFR2H42zPfYLcwaPRWxdUcQ2tZjQv59+dQ2IKYakG6xPipBFz5dnQWmBQKr3J7fidLsfMe7iyEbhfDS9CNJh4uzbMU8G2xiWnfirzpAPN7jQoSW5c+mYAIEuPh7bVYrCM6rjkFO/SsAqMpKKskMyoZNkitFK1D7lDrspR2CKtE0nbUTDJTbA=
      - secure: qMolsG+ZCXo3yxOs51Xlu4ryCBZiWMRT/op5Ygb84wjRUa4gv0haljjv2gxKd3w0lhc5ezAcLPBYdYXDHlBn69L3ENlqN4+MFYaLHrV7DP3wmuXj248+FzvAkTN0rYm+8clDOH2F0nwcNhGrcI7XqADYdHj9G7uBX38g1W8aq2rQRLqG6MhPAk5MSOsyqqr+Ixoa1O6gyTDcEPLJgDTqgUINE7FrurZwnmRtbj6Q12LBAIwAclwBY9mSZbU5Hs1Kwg7jmuPfgZ7WC4dVnO6N+tywKUB9QMTR0D8VudE8AXIeZ8q09kJfYyMc0/KyJD3q9soc4+QGEZXu5xwjP9PWtQjzgEcFDvpMUtQlJNtHw5siVYKueHv9U8FOdR/HccExFDyIwEDTQt/jXzqMLB+tFxlDUpG85AWJwuyPqSW7lTr0lmBrGedeq4v+GYwUmU/KqxUSpL+kxV3BYgb4BrOfeb0e25oVZafzlmWzJuEB9ZSGK7FxiMhv0JcbBCDM/yWx1pI9kdZgehUYZkwCc8dB52Nde1/dsHUahKL2ixFFOGySnBgT/RbG1drtfUW9qhD+CLQe5qyafpDVQjeGIwswlmJLQnYhGStxnT+JYt5oTNz69Bdyhp/kKLBJnmx2qUdeHAt0zH0GtRnPfCKuHqbtkoPPUGXMqIJ2H4MyKLg1I8k=
    on_success: always
    on_failure: always 

